#!/usr/bin/env gremlin

env GLOG_logtostderr
env GLOG_minloglevel 0
env GLOG_logbufsecs 0

tcp-port  1982  1983  1984 \
         22751 22752 22753 \
         22761 22762 22763 \
         23751 23752 23753 \
         23761 23762 23763 \
         24751 24752 24753 \
         24761 24762 24763 \
         25751 25752 25753 \
         25761 25762 25763

run mkdir coord1 coord2 coord3

run mkdir txman1.dc1 txman2.dc1 txman3.dc1
run mkdir txman1.dc2 txman2.dc2 txman3.dc2
run mkdir txman1.dc3 txman2.dc3 txman3.dc3
run mkdir txman1.dc4 txman2.dc4 txman3.dc4

run mkdir kvs1.dc1 kvs2.dc1 kvs3.dc1
run mkdir kvs1.dc2 kvs2.dc2 kvs3.dc2
run mkdir kvs1.dc3 kvs2.dc3 kvs3.dc3
run mkdir kvs1.dc4 kvs2.dc4 kvs3.dc4

daemon consus coordinator --foreground --data=coord1 --listen 127.0.0.1 --listen-port 1982
daemon consus coordinator --foreground --data=coord2 --listen 127.0.0.1 --listen-port 1983 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984
daemon consus coordinator --foreground --data=coord3 --listen 127.0.0.1 --listen-port 1984 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984
run replicant availability-check --servers 3 --timeout 30 --host 127.0.0.1 --port 1984

run consus create-data-center --cluster 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 dc1
run consus create-data-center --cluster 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 dc2
run consus create-data-center --cluster 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 dc3
run consus create-data-center --cluster 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 dc4

run consus set-default-data-center dc1
daemon consus transaction-manager --debug --foreground --data=txman1.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22751
daemon consus transaction-manager --debug --foreground --data=txman2.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22752
daemon consus transaction-manager --debug --foreground --data=txman3.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22753
run consus availability-check --transaction-managers 3 --transaction-manager-groups 1 --timeout 30

run consus set-default-data-center dc2
daemon consus transaction-manager --debug --foreground --data=txman1.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23751
daemon consus transaction-manager --debug --foreground --data=txman2.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23752
daemon consus transaction-manager --debug --foreground --data=txman3.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23753
run consus availability-check --transaction-managers 6 --transaction-manager-groups 2 --timeout 30

run consus set-default-data-center dc3
daemon consus transaction-manager --debug --foreground --data=txman1.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24751
daemon consus transaction-manager --debug --foreground --data=txman2.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24752
daemon consus transaction-manager --debug --foreground --data=txman3.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24753
run consus availability-check --transaction-managers 9 --transaction-manager-groups 3 --timeout 30

run consus set-default-data-center dc4
daemon consus transaction-manager --debug --foreground --data=txman1.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25751
daemon consus transaction-manager --debug --foreground --data=txman2.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25752
daemon consus transaction-manager --debug --foreground --data=txman3.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25753
run consus availability-check --transaction-managers 12 --transaction-manager-groups 4 --timeout 30

run consus set-default-data-center dc1
daemon consus key-value-store --debug --foreground --data=kvs1.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22761
daemon consus key-value-store --debug --foreground --data=kvs2.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22762
daemon consus key-value-store --debug --foreground --data=kvs3.dc1 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 22763
run consus availability-check --key-value-stores 3 --timeout 30

run consus set-default-data-center dc2
daemon consus key-value-store --debug --foreground --data=kvs1.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23761
daemon consus key-value-store --debug --foreground --data=kvs2.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23762
daemon consus key-value-store --debug --foreground --data=kvs3.dc2 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 23763
run consus availability-check --key-value-stores 6 --timeout 30

run consus set-default-data-center dc3
daemon consus key-value-store --debug --foreground --data=kvs1.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24761
daemon consus key-value-store --debug --foreground --data=kvs2.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24762
daemon consus key-value-store --debug --foreground --data=kvs3.dc3 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 24763
run consus availability-check --key-value-stores 9 --timeout 30

run consus set-default-data-center dc4
daemon consus key-value-store --debug --foreground --data=kvs1.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25761
daemon consus key-value-store --debug --foreground --data=kvs2.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25762
daemon consus key-value-store --debug --foreground --data=kvs3.dc4 --connect-string 127.0.0.1:1982,127.0.0.1:1983,127.0.0.1:1984 --listen 127.0.0.1 --listen-port 25763
run consus availability-check --key-value-stores 12 --timeout 30

run replicant availability-check --servers 3 --timeout 30 --host 127.0.0.1 --port 1984
run sleep 10 # XXX
